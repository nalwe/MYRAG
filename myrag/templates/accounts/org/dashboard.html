{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-6 py-6 space-y-8">

  {% if mode == "superuser" %}
  <!-- SUPERUSER BANNER -->
  <div class="flex flex-wrap items-center justify-between gap-3
              bg-purple-100 border border-purple-300
              text-purple-800 rounded-lg px-4 py-3">

    <div class="text-sm font-medium">
      üõ°Ô∏è Viewing organization as Superuser
    </div>

    <form method="get" class="flex items-center gap-2">
      <label class="text-xs font-medium">Switch Organization:</label>

      <select name="org_id"
              onchange="this.form.submit()"
              class="text-sm border border-purple-300 rounded px-2 py-1 bg-white">

        {% for org in organizations %}
          <option value="{{ org.id }}"
            {% if org.id == organization.id %}selected{% endif %}>
            {{ org.name }}
          </option>
        {% endfor %}

      </select>
    </form>

    <a href="{% url 'admin_dashboard' %}"
       class="text-sm underline hover:text-purple-900">
      ‚Üê Admin Dashboard
    </a>

  </div>
  {% endif %}

  <!-- HEADER -->
  <div class="flex justify-between items-center flex-wrap gap-4">

    <div>
      <h1 class="text-2xl font-bold">{{ organization.name }}</h1>
      <p class="text-sm text-gray-500">
        {{ organization.tier_label }} ¬∑ {{ organization.user_count }} users
      </p>
    </div>

    <div class="flex items-center gap-4">
      {% if organization.logo %}
        <img src="{{ organization.logo.url }}"
             class="h-12 w-12 object-contain rounded border">
      {% endif %}

      <a href="{% url 'org_branding' %}"
         class="text-sm text-blue-600 hover:underline">
        Change Logo
      </a>
    </div>

  </div>

  <!-- QUICK ACTIONS -->
  <div class="flex flex-wrap gap-3">

    <a href="{% url 'document_upload' %}"
       class="px-4 py-2 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
      ‚ûï Upload Document
    </a>

    <a href="{% url 'org_invite' %}"
       class="px-4 py-2 text-sm rounded bg-green-600 text-white hover:bg-green-700">
      üë§ Invite User
    </a>

    <a href="{% url 'org_add_user' %}"
       class="px-4 py-2 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-700">
      üë• Add Existing User
    </a>

  </div>

  <!-- API USAGE -->
  <div class="bg-white p-5 rounded-xl shadow border">

    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">API Usage</h3>
      <span class="text-sm text-gray-500">
        {{ organization.api_tokens_used }} / {{ organization.api_token_limit }}
      </span>
    </div>

    <div class="w-full bg-gray-200 rounded h-3">
      <div class="bg-blue-600 h-3"
           style="width:
           {{ organization.api_tokens_used|floatformat:0 }}%;">
      </div>
    </div>

    <p class="text-xs text-gray-500 mt-1">
      Remaining: {{ organization.remaining_tokens }} tokens
    </p>

  </div>

  <!-- DOCUMENTS -->
  <div class="grid md:grid-cols-2 gap-6">

    <!-- Organization Docs -->
    <div class="bg-white p-5 rounded-xl shadow border">
      <h3 class="font-semibold mb-3">Organization Documents</h3>

      {% for doc in org_documents %}
        <div class="flex justify-between text-sm border-b py-1">
          <span class="truncate">{{ doc.display_name }}</span>
          <span class="text-xs">
            {% if doc.is_public %}
              Public
            {% else %}
              Private
            {% endif %}
          </span>
        </div>
      {% empty %}
        <p class="text-gray-400 text-sm">No documents yet.</p>
      {% endfor %}

    </div>

    <!-- Global Docs -->
    <div class="bg-white p-5 rounded-xl shadow border">
      <h3 class="font-semibold mb-3">Global Documents</h3>

      {% for doc in global_documents %}
        <div class="text-sm border-b py-1 truncate">
          üåç {{ doc.display_name }}
        </div>
      {% empty %}
        <p class="text-gray-400 text-sm">No global documents.</p>
      {% endfor %}

    </div>

  </div>

  <!-- USERS PANEL -->
    <div class="bg-white p-6 rounded-xl shadow border">

  <h3 class="font-semibold mb-2">
    User Provisioning
  </h3>

  <p class="text-sm text-gray-500 mb-4">
    Create users and assign organization roles
  </p>

  <a href="{% url 'admin_create_user' %}"
     class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
     ‚ûï Create User
  </a>

</div>
  <div class="bg-white p-5 rounded-xl shadow border">

    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">Organization Users</h3>

      <a href="{% url 'org_user_list' %}"
         class="text-indigo-600 text-sm hover:underline">
        View All Users ‚Üí
      </a>
      <a href="{% url 'org_bulk_add_users' %}"
   class="px-4 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700">
   üìÇ Bulk Upload Users
</a>

    </div>
   
    <div class="overflow-x-auto">
      <table class="w-full text-sm">

        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">User</th>
            <th class="p-2 text-center">Role</th>
            <th class="p-2 text-center">Status</th>
            <th class="p-2 text-center">Security</th>
            <th class="p-2 text-center">Last Login</th>
          </tr>
        </thead>

        <tbody class="divide-y">

          {% for m in members_preview %}
          <tr class="hover:bg-gray-50">

            <td class="p-2">
              <div class="font-medium">{{ m.user.username }}</div>
              <div class="text-xs text-gray-400">{{ m.user.email }}</div>
            </td>

            <td class="p-2 text-center">
              {% if m.role == "owner" %}
                <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs">Owner</span>
              {% elif m.role == "admin" %}
                <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">Admin</span>
              {% else %}
                <span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded text-xs">Member</span>
              {% endif %}
            </td>

            <td class="p-2 text-center">
              {% if m.user.is_active %}
                <span class="text-green-600 text-xs">Active</span>
              {% else %}
                <span class="text-red-600 text-xs">Inactive</span>
              {% endif %}
            </td>

            <td class="p-2 text-center">
              {% if m.user.profile.must_change_password %}
                <span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs">
                  Reset Required
                </span>
              {% else %}
                <span class="text-gray-400 text-xs">‚Äî</span>
              {% endif %}
            </td>

            <td class="p-2 text-center text-xs text-gray-500">
              {% if m.user.profile.last_login_at %}
                {{ m.user.profile.last_login_at|date:"M d, Y H:i" }}
              {% else %}
                Never
              {% endif %}
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="p-4 text-center text-gray-400">
              No users found.
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

  </div>

</div>

{% endblock %}
