{% extends "base.html" %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-2xl shadow-sm border">

  <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
    üì§ Upload Documents
  </h2>

  <form id="upload-form" method="post" enctype="multipart/form-data" class="space-y-5">
    {% csrf_token %}

    <!-- DRAG & DROP -->
    <div
      id="drop-zone"
      class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer bg-gray-50 hover:bg-blue-50 transition"
    >
      <p class="text-sm text-gray-600">
        Drag & drop files here <br>
        <span class="text-blue-600 font-medium">or click to select</span>
      </p>

      <input
        type="file"
        id="file-input"
        name="files"
        multiple
        required
        hidden
      >
    </div>

    <p id="file-list" class="text-xs text-gray-500"></p>

    <!-- FOLDER -->
    {% if folders %}
      <div>
        <label class="block text-sm font-medium mb-1">
          üìÅ Select Folder
        </label>

        <select name="folder"
                class="border rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="">‚Äî No Folder (Goes to All Documents) ‚Äî</option>
          {% for folder in folders %}
            <option value="{{ folder.id }}">{{ folder.name }}</option>
          {% endfor %}
        </select>

        <p class="text-xs text-gray-400 mt-1">
          Choose where these documents should be organized.
        </p>
      </div>
    {% endif %}

    <!-- VISIBILITY -->
    <div class="border rounded-lg p-3 bg-gray-50">
      <label class="flex items-center gap-2 text-sm">
        <input
          type="checkbox"
          name="is_public"
          class="rounded border-gray-300"
        >
        <span class="font-medium">Make documents public</span>
      </label>
      <p class="text-xs text-gray-500 mt-1">
        Public documents can be viewed and searched by all users.
      </p>
    </div>

    <!-- PROGRESS BAR -->
    <div id="progress-wrapper" class="hidden">
      <div class="w-full bg-gray-200 rounded-full">
        <div
          id="progress-bar"
          class="bg-blue-600 text-xs text-white text-center py-1 rounded-full transition-all duration-200"
          style="width: 0%"
        >
          0%
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="flex justify-end gap-3 pt-2">

      <a href="{% url 'documents:document_list' %}"
         class="px-4 py-2 border rounded-lg text-sm hover:bg-gray-100">
        Back
      </a>

      <button
        type="button"
        id="cancel-upload"
        class="hidden px-4 py-2 border border-red-500 text-red-600 rounded-lg text-sm hover:bg-red-50"
      >
        Cancel
      </button>

      <button
        type="submit"
        id="upload-btn"
        class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 shadow-sm"
      >
        Upload Files
      </button>

    </div>

  </form>
</div>

<!-- TOAST -->
<div
  id="toast"
  class="fixed bottom-5 right-5 hidden bg-green-600 text-white px-4 py-2 rounded-lg shadow"
></div>

<!-- JAVASCRIPT -->
<script>
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input");
  const fileList = document.getElementById("file-list");
  const form = document.getElementById("upload-form");

  const progressWrapper = document.getElementById("progress-wrapper");
  const progressBar = document.getElementById("progress-bar");

  const cancelUploadBtn = document.getElementById("cancel-upload");
  const uploadBtn = document.getElementById("upload-btn");

  let xhr = null;

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
  }

  // Drag & Drop Click
  dropZone.addEventListener("click", () => fileInput.click());

  // Drag styling
  dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("bg-blue-50");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("bg-blue-50");
  });

  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("bg-blue-50");
    fileInput.files = e.dataTransfer.files;
    showFiles();
  });

  fileInput.addEventListener("change", showFiles);

  // ‚úÖ IMPROVED showFiles()
  function showFiles() {
  if (fileInput.files.length === 0) {
    fileList.innerText = "";
    return;
  }

  const MAX_SIZE = 15 * 1024 * 1024; // 15MB
  let validFiles = [];
  let messages = [];

  [...fileInput.files].forEach(file => {
    if (file.size > MAX_SIZE) {
      messages.push(`${file.name} ‚ùå exceeds 15MB`);
    } else {
      validFiles.push(file);
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      messages.push(`${file.name} (${sizeMB} MB)`);
    }
  });

  if (validFiles.length !== fileInput.files.length) {
    showToast("Some files exceeded 15MB and were ignored.");
  }

  fileList.innerText = messages.join(" | ");
}

  // AJAX Upload
  form.addEventListener("submit", e => {
    e.preventDefault();

    xhr = new XMLHttpRequest();
    const formData = new FormData(form);

    xhr.open("POST", window.location.href);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

    progressWrapper.classList.remove("hidden");
    cancelUploadBtn.classList.remove("hidden");
    uploadBtn.disabled = true;

    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percent + "%";
        progressBar.innerText = percent + "%";
      }
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);

          if (response.success) {
            showToast("Upload successful!");
            setTimeout(() => {
              window.location.href = "{% url 'documents:document_list' %}";
            }, 1200);
          } else {
            resetUpload(response.error || "Upload failed");
          }
        } catch {
          resetUpload("Unexpected server response");
        }
      } else {
        resetUpload("Upload failed");
      }
    };

    xhr.onerror = () => resetUpload("Upload failed");

    xhr.send(formData);
  });

  // Cancel Upload
  cancelUploadBtn.addEventListener("click", () => {
    if (xhr) {
      xhr.abort();
      resetUpload("Upload cancelled");
    }
  });

  function resetUpload(message) {
    progressWrapper.classList.add("hidden");
    cancelUploadBtn.classList.add("hidden");
    uploadBtn.disabled = false;

    progressBar.style.width = "0%";
    progressBar.innerText = "0%";

    fileInput.value = "";
    fileList.innerText = "";

    if (message) showToast(message);
  }
</script>

{% endblock %}