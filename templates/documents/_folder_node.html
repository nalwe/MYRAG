{% load get_item %}

<li class="relative ml-2"
    data-folder-id="{{ folder.id }}"
    ondragover="window.allowDrop(event)"
    ondrop="window.dropFolder(event)">

  <!-- =========================
       FOLDER ROW
  ========================== -->
  <div class="flex items-center gap-1 group select-none
              {% if active_folder == folder.id|stringformat:'s' %}
                bg-green-50 rounded
              {% endif %}">

    <!-- DRAG HANDLE -->
    <span class="cursor-grab text-gray-400 px-1"
          draggable="true"
          ondragstart="window.dragFolder(event)"
          title="Drag folder">
      â˜°
    </span>

    <!-- TREE TOGGLE -->
    {% if folder.children.exists %}
      <button type="button"
              onclick="toggleFolder('{{ folder.id }}'); this.classList.toggle('rotate-90')"
              class="text-xs text-gray-500 w-4 transition-transform
                     {% if active_folder == folder.id|stringformat:'s' %}
                       rotate-90
                     {% endif %}">
        â–¶
      </button>
    {% else %}
      <span class="w-4"></span>
    {% endif %}

    <!-- âœ… FOLDER CHAT LINK (UPDATED) -->
    <a href="{% url 'chat_view' %}?folder={{ folder.id }}"
       onclick="event.stopPropagation()"
       class="flex items-center gap-1 truncate rounded px-2 py-1
              {% if active_folder == folder.id|stringformat:'s' %}
                font-semibold text-green-800 bg-green-100 border-l-4 border-green-500
              {% else %}
                hover:bg-gray-100 hover:text-green-700
              {% endif %}">
      ğŸ“ {{ folder.name }}
    </a>

    <!-- =========================
         ACTIONS (HOVER)
    ========================== -->
    {% if request.user.is_staff or folder.uploaded_by == request.user %}
    <div class="ml-2 hidden group-hover:flex gap-1 text-xs">

      <!-- CREATE SUBFOLDER -->
      <button type="button"
              onclick="toggleSubfolderForm('{{ folder.id }}')"
              class="text-green-600 hover:text-green-800"
              title="Create subfolder">
        â•
      </button>

      <!-- RENAME -->
      <form method="post"
            action="{% url 'documents:rename_folder' folder.id %}"
            onclick="event.stopPropagation()">
        {% csrf_token %}
        <button type="submit"
                class="text-gray-500 hover:text-blue-600">
          âœ
        </button>
      </form>

      <!-- DELETE -->
      <form method="post"
            action="{% url 'documents:delete_folder' folder.id %}"
            onsubmit="event.stopPropagation(); return confirm('Delete folder and all contents?')">
        {% csrf_token %}
        <button type="submit"
                class="text-red-500 hover:text-red-700">
          ğŸ—‘
        </button>
      </form>

    </div>
    {% endif %}
  </div>

  <!-- =========================
       CREATE SUBFOLDER FORM
  ========================== -->
  {% if request.user.is_staff or folder.uploaded_by == request.user %}
  <form id="subfolder-form-{{ folder.id }}"
        onsubmit="createSubfolder(event, '{{ folder.id }}')"
        class="hidden ml-6 mt-1 space-y-1"
        onclick="event.stopPropagation()">
    {% csrf_token %}

    <input type="text"
           name="name"
           required
           placeholder="Subfolder name"
           class="w-full px-2 py-1 border rounded text-xs">

    <div class="flex gap-1">
      <button type="submit"
              class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
        Create
      </button>
      <button type="button"
              onclick="toggleSubfolderForm('{{ folder.id }}')"
              class="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">
        Cancel
      </button>
    </div>
  </form>
  {% endif %}

  <!-- =========================
       CHILDREN (ANIMATED)
  ========================== -->
  {% if folder.children.exists %}
    <ul id="children-{{ folder.id }}"
        class="ml-4 mt-1 border-l border-gray-200 pl-2
               overflow-hidden transition-[max-height,opacity]
               duration-300 ease-in-out
               {% if active_folder == folder.id|stringformat:'s' %}
                 max-h-[1000px] opacity-100
               {% else %}
                 max-h-0 opacity-0
               {% endif %}">
      {% for child in folder.children.all %}
        {% include "documents/_folder_node.html" with folder=child %}
      {% endfor %}
    </ul>
  {% endif %}
</li>
