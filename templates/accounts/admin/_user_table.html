<form method="post" action="{% url 'admin_bulk_deactivate' %}">
{% csrf_token %}

<div class="mb-3 flex gap-4 items-center">
    <button
        type="submit"
        class="bg-red-600 text-white px-4 py-2 rounded text-sm"
        onclick="return confirm('Deactivate selected users?')"
    >
        Deactivate Selected
    </button>
</div>

<table class="w-full border text-sm">
<thead>
<tr class="bg-gray-100">
    <th class="p-2">
        <input type="checkbox" onclick="toggleAll(this)">
    </th>
    <th>Username</th>
    <th>Email</th>
    <th>Role</th>
    <th>Change Role</th>
    <th>Status</th>
</tr>
</thead>

<tbody>
{% for u in page_obj %}
<tr class="border-t align-middle">

    <!-- SELECT -->
    <td class="p-2">
        <input type="checkbox" name="users" value="{{ u.id }}">
    </td>

    <!-- USER -->
    <td>{{ u.username }}</td>
    <td>{{ u.email }}</td>

    <!-- CURRENT ROLE -->
    <td class="font-semibold">
        {{ u.profile.role|title }}
    </td>

    <!-- CHANGE ROLE -->
    <td>
        <div class="flex gap-2 items-center">

            <form method="post"
                  action="{% url 'admin_change_role' u.id %}">
                {% csrf_token %}

                <select name="role"
                        class="border rounded px-2 py-1 text-sm">

                    <option value="basic" {% if u.profile.role == "basic" %}selected{% endif %}>
                        Basic
                    </option>

                    <option value="premium" {% if u.profile.role == "premium" %}selected{% endif %}>
                        Premium
                    </option>

                    <option value="admin" {% if u.profile.role == "admin" %}selected{% endif %}>
                        Admin
                    </option>
                </select>

                <button type="submit"
                        onclick="return confirm('Change role for {{ u.username }}?')"
                        class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                    Change
                </button>

            </form>

        </div>
    </td>

    <!-- STATUS -->
    <td>
        {% if u.is_active %}
            <span class="text-green-600">Active</span>
        {% else %}
            <span class="text-red-600">Inactive</span>
        {% endif %}
    </td>

</tr>
{% empty %}
<tr>
    <td colspan="6" class="p-4 text-center text-gray-500">
        No users found.
    </td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- Pagination -->
<div class="flex justify-between items-center mt-4">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&q={{ query }}&role={{ role }}"
           class="text-blue-600">← Prev</a>
    {% endif %}

    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&q={{ query }}&role={{ role }}"
           class="text-blue-600">Next →</a>
    {% endif %}
</div>

</form>

<script>
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('input[name="users"]');
    checkboxes.forEach(cb => cb.checked = source.checked);
}
</script>
